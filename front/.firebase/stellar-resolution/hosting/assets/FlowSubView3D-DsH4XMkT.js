import{db as m,rA as S,bd as b,ax as v,rB as x,ao as g,cM as $,cO as R,mC as L,W as C,mq as z,u as D,pU as I,c as T,r as a,m as u,b as _,rC as F,ep as E,b2 as V,dl as W,$ as q,dj as M,aE as P,hV as j,iK as k,eo as A,e$ as G,mK as H}from"./index-BCRx-hwS.js";import{c as B,u as U,g as K}from"./dataUtils-Nj-Pa24a.js";import{p as N}from"./SubView3D-DDpKXTIC.js";import{R as O,b as X}from"./line-CjGKkHIf.js";function Y(e){const t=Z(J(e)),n=t,i=!0,s=Math.max(t/2,5),r=Math.round(m(e.maxPathLength)/s)+1,l=10,{density:o}=e;return{smoothing:m(e.smoothing),interpolate:!0,velocityScale:e.flowRepresentation==="flow-from"?1:-1,verticesPerLine:r,minSpeedThreshold:.001,segmentLength:s,maxTurnAngle:1,collisions:i,lineCollisionWidth:n,lineSpacing:l,density:o}}function Z(e){return e.kind==="constant"?e.value[0]:e.values[e.values.length-1]}function J(e){if(!e.hasVisualVariables("size"))return{kind:"constant",value:[m(e.trailWidth)]};const t=e.getVisualVariablesForType("size")[0],n=[],i=[];let s;if(t.stops){for(const r of t.stops)n.push(r.value),i.push(m(r.size));s=t.stops.length}else n.push(t.minDataValue,t.maxDataValue),i.push(m(t.minSize),m(t.maxSize)),s=2;return{kind:"ramp",stops:n,values:i,count:s}}function Q(e,t){let n=!0;return n=n&&e.collisions===t.collisions,n=n&&e.density===t.density,n=n&&e.interpolate===t.interpolate,n=n&&e.lineCollisionWidth===t.lineCollisionWidth,n=n&&e.lineSpacing===t.lineSpacing,n=n&&e.maxTurnAngle===t.maxTurnAngle,n=n&&e.minSpeedThreshold===t.minSpeedThreshold,n=n&&e.segmentLength===t.segmentLength,n=n&&e.smoothing===t.smoothing,n=n&&e.velocityScale===t.velocityScale,n=n&&e.verticesPerLine===t.verticesPerLine,n}function ee(e,t,n,i){const{spatialReference:s}=e;return te(n.map(r=>r.map(l=>{const[o,c]=ne(l,t),{absoluteZ:w}=S(o,c,0,s,e,i),p=b(o,c,w);return e.renderCoordsHelper.toRenderCoords(p,s,p),p})))}function te(e){const t=O(e),n=new v({width:2,color:g(.1,.2,1,1),innerWidth:1,innerColor:g(.2,.4,1,1),cap:x.ROUND});return t.map(i=>X(n,i))}function ne({x:e,y:t},n){const{extent:i,size:[s,r]}=n;return[e/s*i.width+i.xmin,(r-t)/r*i.height+i.ymin]}function ie(e,t,n){let[i,s,r,l]=[null,null,null,null];for(t.reset(e);!t.done;){const o=t.next();if(o==null)continue;if(!o.visible){t.skipSubtree();continue}const c=o.extent;o.leaf&&o.rendered&&$(c,n)&&(i=f(c[0],i),s=f(c[1],s),r=y(c[2],r),l=y(c[3],l))}return i==null||s==null||r==null||l==null?null:R([i,s,r,l])}function y(e,t){return t==null?e:Math.max(e,t)}function f(e,t){return t==null?e:Math.min(e,t)}class se{constructor(t,n){this.streamlines=t,this._geometries=n,this._object3D=null,this._engineLayer=null}get attached(){return this._object3D!=null&&this._engineLayer!=null}attach(t){const{_geometries:n}=this;if(n==null)return;this.detach();const i=new L(t,{pickable:!1,updatePolicy:C.SYNC}),s=new z({geometries:n});s.visible=!0,i.add(s),this._object3D=s,this._engineLayer=i}detach(){this.attached&&(this._engineLayer=D(this._engineLayer),this._object3D=I(this._object3D))}}let d=class extends T{constructor(e){super(e),this.simulationSettings=null,this.loadImagery=null,this.createGeometry=null}async load(e,t){const n=await this.loadImagery(e,t);if(n==null)return null;const i=this._createFlowFieldFromData(n),s=this._getStreamlines(e,i),r=this.createGeometry(e,s);return new se(s,r)}_createFlowFieldFromData(e){return B(this.simulationSettings,e)}_getStreamlines(e,t){const{size:[n,i]}=e;return U(this.simulationSettings,t,n,i)}};a([u()],d.prototype,"simulationSettings",void 0),a([u()],d.prototype,"loadImagery",void 0),a([u()],d.prototype,"createGeometry",void 0),d=a([_("esri.views.3d.support.flow.StreamlinesStyle3D")],d);let h=class extends N{constructor(e){super(e),this.type="flow",this._preorderIterator=new F,this._abortController=null,this._debouncedLoad=E(async()=>{var o;const{view:t,_style:n}=this;if(n==null)return;const i=this._computeExtent();if(i==null)return;const s={extent:i,timeExtent:this.layer.timeExtent,size:this._viewSizeWithEqualRatio(i),pixelRatio:t.state.contentPixelRatio};this._abortController==null&&(this._abortController=new AbortController);const r=this._abortController,l=await n.load(s,r.signal);V(r.signal),l!=null&&((o=this._resources)==null||o.detach(),l.attach(t.stage),this._resources=l)}),this._loadImagery=(t,n)=>{const{extent:i,size:[s,r],timeExtent:l}=t;return K(this.layer,i,s,r,l,n)},this._createFlowGeometry=(t,n)=>ee(this.view,t,n,this.elevationInfo)}initialize(){this.addHandles([W(()=>this.newStyleRequired,()=>this._updateStyle(),q)]),this.updatingHandles.add(()=>this._style,()=>this._triggerLoad()),this._updateStyle(),this.updatingHandles.addWhen(()=>{var e;return!((e=this.view.basemapTerrain)!=null&&e.updating)},()=>this._triggerLoad())}destroy(){this._abortController=M(this._abortController),this.clear()}get layer(){return this.layerView.layer}get flowRenderer(){const e=this.layer.renderer;return(e==null?void 0:e.type)!=="flow"?null:e}get elevationInfo(){return new P({mode:"absolute-height",offset:1e3})}get dataBounds(){const{fullExtent:e}=this.layer,{spatialReference:t}=this.view.basemapTerrain,n=j(e,t).geometry;return n==null?null:k(n)}get simulationSettings(){const{flowRenderer:e}=this;return e==null?null:Y(e)}get newStyleRequired(){var n;const e=(n=this._style)==null?void 0:n.simulationSettings,t=this.simulationSettings;return e!=null&&t!=null&&!Q(e,t)}doRefresh(){return this._triggerLoad()}clear(){var e;(e=this._resources)==null||e.detach(),this._resources=null}_triggerLoad(){return A(this.updatingHandles.addPromise(this._debouncedLoad()))}_updateStyle(){var t;const{simulationSettings:e}=this;e!=null&&((t=this._style)==null||t.destroy(),this._style=new d({simulationSettings:e,loadImagery:this._loadImagery,createGeometry:this._createFlowGeometry}))}_computeExtent(){const e=this.view.basemapTerrain,t=e==null?void 0:e.rootTiles;if(t==null||t.length===0)return null;const{spatialReference:n}=e,{dataBounds:i}=this;if(!n||i==null)return null;const s=ie(t,this._preorderIterator,i);return s==null?null:(H(s,i,s),G(s,n))}_viewSizeWithEqualRatio(e){const t=(e.xmax-e.xmin)/(e.ymax-e.ymin),[n,i]=this.view.size;return n<i?[n,Math.floor(n/t)]:[Math.floor(i*t),i]}get test(){}};a([u()],h.prototype,"type",void 0),a([u()],h.prototype,"_style",void 0),a([u()],h.prototype,"layer",null),a([u()],h.prototype,"flowRenderer",null),a([u()],h.prototype,"elevationInfo",null),a([u()],h.prototype,"dataBounds",null),a([u()],h.prototype,"simulationSettings",null),a([u()],h.prototype,"newStyleRequired",null),h=a([_("esri.views.3d.layers.FlowSubView3D")],h);export{h as b};
