import{BG as te,BH as se,DY as Pe,BS as W,E1 as Re,BP as R,BT as re,BU as oe,_ as ie,BW as ae,B$ as ne,E3 as le,E4 as w,DP as ce,r as u,m as d,b as S,mS as Ce,az as Se,Cp as Oe,Co as Te,pt as xe,bh as F,ny as N,En as K,Eo as De,DT as Me,DU as D,nz as Y,nA as f,Ep as Fe,lt as J,tr as Ne,ts as Ve,Eq as ke,tf as Ge,tg as Ie,c as ue,Z as P,a as M,u as C,ap as qe,J as Q,aD as Be,V as je,a3 as He,k3 as Le,al as Ue,i as ze,aO as We,aP as Ke,cX as Ye,iH as Je,au as Qe,fJ as Xe,iG as Ze,mm as et,jw as tt,iY as st,aA as rt,aG as X,kX as ot,bv as it,s as at}from"./index-BCRx-hwS.js";import{t as nt}from"./operatorDensify-tSuNWtxY.js";import{e as lt}from"./operatorSimplify-Dhzp2Ew2.js";import{fromSpatialReference as ct,fromPolygon as ut,toPolygon as ht}from"./apiConverter-Da8xt-f2.js";import{p as dt,n as pt}from"./Graphics3DExtrudeSymbolLayer-CAguDFa1.js";import{j as mt}from"./OutlineVisualElement-CWIJ9YT0.js";import"./SimpleGeometryCursor-B92kdZ15.js";import"./ProjectionTransformation-CoAUJI3p.js";import"./Envelope2D-C_JUGA2P.js";import"./Point2D-CXC1yv_O.js";import"./Transformation2D-sny6HUws.js";import"./OperatorDefinitions-DP7_WWTp.js";import"./jsonConverter-BHyufzdl.js";import"./SnappingCandidate-DGkpYqI6.js";import"./renderingInfoUtils-BAhgEqIm.js";import"./triangulationUtils-Di5oVG4z.js";import"./deduplicate-CPLnnGyZ.js";import"./EngineVisualElement-CI6xbbHp.js";import"./VisualElement-C7VHkPsy.js";import"./LaserlinePath.glsl-BAMGwSy6.js";import"./line-CjGKkHIf.js";import"./line-DHYzfKao.js";var A;(function(e){e[e.BRIGHT=0]="BRIGHT",e[e.DARK=1]="DARK"})(A||(A={}));let V=class extends te{constructor(){super(...arguments),this.effect=A.BRIGHT}};function he(){const e=new se;return e.include(Pe),e.outputs.add("fragColor","vec4",0),e.fragment.uniforms.add(new W("colorTexture",t=>t.color),new W("focusArea",t=>t.focusArea),new Re("focusAreaEffectMode",t=>t.effect)).main.add(R`
      float mask = texture( focusArea, uv, 0.0 ).r;
      vec4 color = texture( colorTexture, uv, 0.0 );
      vec4 colorDeSaturate = vec4(color.r * 0.25 + color.g * 0.5 + color.b * 0.25);
      if (focusAreaEffectMode == ${R.int(A.BRIGHT)}) {
        fragColor = mask > 0.0 ? color : 0.55 * colorDeSaturate + 0.45;
      } else {
        fragColor = mask > 0.0 ? color : 0.33 * mix(color, colorDeSaturate, 0.);
      }
  `),e}const ft=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:V,build:he},Symbol.toStringTag,{value:"Module"}));class Z extends re{constructor(t,s){super(t,s,new oe(ft,()=>ie(()=>Promise.resolve().then(()=>yt),void 0)))}initializePipeline(){return ae({colorWrite:ne})}}let g=class extends le{constructor(e){super({...e,view:e.focusAreasView.view}),this.consumes={required:[w.FOCUSAREA_COLOR,w.FOCUSAREA]},this.produces=w.FOCUSAREA_COLOR,this._passParameters=new V}precompile(){this.techniques.precompile(Z)}render(e){const t=this.techniques.get(Z),s=e.find(({name:p})=>p===this.produces);if(!t.compiled)return this.requestRender(),s;const a=this.focusAreasView.style,i=this.bindParameters,n=i.camera,r=n.fullViewport[2],o=n.fullViewport[3],l=e.find(({name:p})=>p===w.FOCUSAREA),m=this.fboCache.acquire(r,o,this.produces),c=this.renderingContext;return c.bindFramebuffer(m.fbo),this._passParameters.color=s.getTexture(),this._passParameters.focusArea=l.getTexture(),this._passParameters.effect=gt[a],c.bindTechnique(t,i,this._passParameters),c.screen.draw(),m.attachDepth(s.getAttachment(ce)),m}};u([d()],g.prototype,"consumes",void 0),u([d()],g.prototype,"produces",void 0),u([d({constructOnly:!0})],g.prototype,"focusAreasView",void 0),g=u([S("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaColorNode")],g);const gt={bright:A.BRIGHT,dark:A.DARK};class k extends te{constructor(){super(...arguments),this.origin=Ce}}function de(){const e=new se;return e.attributes.add(Se.POSITION,"vec3"),e.outputs.add("fragColor","vec4",0),e.vertex.uniforms.add(new Oe("proj",t=>t.camera.projectionMatrix),new Te("view",(t,s)=>xe(_t,s.camera.viewMatrix,t.origin))).main.add(R`gl_Position = proj * view * vec4(position, 1.0);
gl_Position.z = min(gl_Position.z, gl_Position.w);`),e.fragment.main.add(R`fragColor = vec4(1., 0., 0., 0.);`),e}const _t=F(),wt=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:k,build:de},Symbol.toStringTag,{value:"Module"}));class ee extends re{constructor(t,s){super(t,s,new oe(wt,()=>ie(()=>Promise.resolve().then(()=>Et),void 0)))}initializePipeline(){return ae({colorWrite:ne,depthTest:{func:N.LEQUAL}})}}let _=class extends le{constructor(e){super({...e,view:e.focusAreasView.view}),this.consumes={required:[K.TRANSPARENT]},this.produces=w.FOCUSAREA,this._vaos=new Array,this._counts=new Array,this._origins=new Array,this._maskParameters=new k}initialize(){this.updateGeometries()}destroy(){this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0}precompile(){this.techniques.precompile(ee)}render(e){const t=this.techniques.get(ee),s=this.bindParameters,a=s.camera,i=a.fullViewport[2],n=a.fullViewport[3];if(!t.compiled||!this._vaos)return void this.requestRender();const r=e.find(({name:c})=>c===K.TRANSPARENT),o=this.renderingContext,l=this.fboCache.acquire(i,n,w.FOCUSAREA,De.RG8UNORM);this.view.stage.renderer.occludedRequiresStencil?(l.acquireDepth(Me.DEPTH24_STENCIL8),o.blitFramebuffer(r.fbo,l.fbo,D.DEPTH)):l.attachDepth(r.getAttachment(ce)),o.bindFramebuffer(l.fbo),o.setClearColor(0,0,0,1),o.clear(D.COLOR|D.STENCIL),o.setViewport(0,0,i,n);const m=o.bindTechnique(t,s);o.setFaceCullingEnabled(!1),o.setStencilTestEnabled(!0),o.setStencilOpSeparate(Y.FRONT,f.KEEP,f.INCR_WRAP,f.KEEP),o.setStencilOpSeparate(Y.BACK,f.KEEP,f.DECR_WRAP,f.KEEP),o.setDepthWriteEnabled(!1);for(let c=0;c<this._vaos.length;c++){const p=this._vaos[c],h=this._counts[c];this._maskParameters.origin=this._origins[c],m.bindDraw(s,Fe,this._maskParameters),o.bindVAO(p),o.setDepthTestEnabled(!0),o.setStencilWriteMask(255),o.setStencilFunction(N.ALWAYS,0,255),o.setColorMask(!1,!1,!1,!1),o.drawArrays(J.TRIANGLES,0,h),o.setDepthTestEnabled(!1),o.setStencilWriteMask(0),o.setStencilFunction(N.NOTEQUAL,0,255),o.setColorMask(!0,!0,!0,!0),o.drawArrays(J.TRIANGLES,0,h)}return l}updateGeometries(){this.view.stage&&(this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0,this.focusAreasView.volumes.forEach(e=>e.forEach(t=>{const s=new Array,a=t.indicesBottom;for(let r=0;r<a.length;r++)s.push(t.positions[3*(a[r]-1)]),s.push(t.positions[3*(a[r]-1)+1]),s.push(t.positions[3*(a[r]-1)+2]);const i=t.indicesExtruded;for(let r=0;r<i.length;r++)s.push(t.positions[3*i[r]]),s.push(t.positions[3*i[r]+1]),s.push(t.positions[3*i[r]+2]);const n=new Ne(this.renderingContext,Ve,new Map([["geometry",ke]]),new Map([["geometry",Ge.createVertex(this.renderingContext,Ie.STATIC_DRAW,new Float32Array(s))]]));this._vaos.push(n),this._counts.push(a.length+i.length),this._origins.push(t.origin)})),this.requestRender())}};u([d()],_.prototype,"consumes",void 0),u([d()],_.prototype,"produces",void 0),u([d({constructOnly:!0})],_.prototype,"focusAreasView",void 0),_=u([S("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaMaskNode")],_);class At{constructor(t,s,a,i,n){this.positions=t,this.indicesBottom=s,this.indicesExtruded=a,this.height=i,this.origin=n}}let y=class extends ue{constructor(e){super(e)}initialize(){this.addHandles([P(()=>this.area.enabled,()=>this._ensureElement(),M),P(()=>{var e;return(e=this.area.outline)==null?void 0:e.color},e=>this._updateColor(e),M),P(()=>this.area.geometries,e=>this._updateGeometries(e),M)])}destroy(){this.removeAllHandles(),this._outlineElement=C(this._outlineElement)}_ensureElement(){var e,t;this.area.enabled&&((e=this.area.outline)!=null&&e.color)?this._outlineElement??(this._outlineElement=new mt({view:this.view,geometry:this._mergePolygons(this.area.geometries),isDraped:!0,attached:!0,isDecoration:!1,color:Q.toUnitRGBA((t=this.area.outline)==null?void 0:t.color),renderOccluded:qe.OccludeAndTransparent,width:3})):this._outlineElement=C(this._outlineElement)}_updateGeometries(e){this._ensureElement(),this._outlineElement&&(this._outlineElement.geometry=this._mergePolygons(e))}_updateColor(e){this._ensureElement(),this._outlineElement&&e&&(this._outlineElement.color=Q.toUnitRGBA(e))}_mergePolygons(e){if(!e||e.length===0)return null;const t=e.at(0).clone();return e.forEach(s=>{t.rings.push(...s.rings)}),t}};u([d({constructOnly:!0})],y.prototype,"view",void 0),u([d({constructOnly:!0})],y.prototype,"area",void 0),y=u([S("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaOutlineItem")],y);const vt=2e4;let b=class extends ue{constructor(e){super(e),this._volumes=new Map,this._elevationContext=new Be,this._outlineMap=new je}initialize(){this.addHandles([P(()=>this.polygons,e=>this._updateVolumes(e),He)]),this._outlineMap=Le(()=>{var e;return(e=this.areas)==null?void 0:e.areas},e=>new y({area:e,view:this.view}),{recycleItems:!0})}destroy(){this.removeAllHandles(),this._outlineMap.destroy()}get areas(){var e;return(e=this.view.map)==null?void 0:e.focusAreas}get enabledAreas(){var e;return((e=this.areas)==null?void 0:e.areas.toArray().filter(({enabled:t})=>t))??[]}get style(){var e;return((e=this.areas)==null?void 0:e.style)??"bright"}get polygons(){return this.enabledAreas.reduce((e,t)=>e.concat(t.geometries.toArray()),new Array)}containsGeometry(e){if(this.polygons.length===0)return!0;const t=new Ue(e);return this.polygons.some(s=>s.contains(t))}_updateVolumes(e){this._extrude(e),this._ensureRenderNodes()}_extrude(e){var p;if(!this.view.renderCoordsHelper||ze(Array.from(this._volumes.keys()),e))return;const t=this.view.renderCoordsHelper,s=Qe(),a=t.viewingMode===We.Global,i=F(),n=F(),r=this.view.spatialReference,o=ct(r),l=Ke(r).radius/Ye.radius,m=Je(5e5*l,"meters",r,!0);a||t.worldUpAtPosition([0,0,0],s);const c=new Map;for(const h of e){const G=this._volumes.get(h);if(G)c.set(h,G);else try{const v=r.equals(h.spatialReference)?h:Xe(h,r),pe=Math.max(v.extent.width,v.extent.height),me=Ze(pe,r,"meters",!0),O=Math.max(5*me,vt*l),fe=a?l/10:l,I=this._reduceGeometryHeight(v,O,fe),T=et(I);if(T==null)continue;const q=ut(I),ge=lt(q,o,!1)??q,_e=nt(ge,m,0,0),B=ht(_e,r);if(B==null)continue;tt(r,[T.x,T.y,0],i,t.spatialReference),n[12]=-i[12],n[13]=-i[13],n[14]=-i[14];const we=dt(B,this.view.elevationProvider,t,this._elevationContext),{polygons:Ae,mapPositions:ve,position:ye}=we,j=new Array;for(const E of Ae){const Ee=E.count,x=st(E.mapPositions,E.holeIndices,3);if(x.length===0)continue;const H=x.length,L=6*Ee,$e=L+H,$=rt(3*L),U=X($e),z=X(H);pt(ye,ve,x,E,$,null,null,null,U,z,O,s,a),ot($,$,n);const be=new At($,z,U,O,[i[12],i[13],i[14]]);j.push(be)}c.set(h,j)}catch(v){it.getLogger(this).error(new at("focusareasview:projection-failed","Failed to project focus area geometry to view spatial reference",{geometry:h,error:v}))}}this._volumes=c,(p=this._maskRenderNode)==null||p.updateGeometries()}_ensureRenderNodes(){this.view.stage&&(this.volumes.size===0?(this._maskRenderNode=C(this._maskRenderNode),this._colorRenderNode=C(this._colorRenderNode)):(this._maskRenderNode??(this._maskRenderNode=new _({focusAreasView:this})),this._colorRenderNode??(this._colorRenderNode=new g({focusAreasView:this})),this.view.stage.renderView.requestRender()))}_reduceGeometryHeight(e,t,s){const a=-12e5*s,i=Math.max(-t/2,a),n=e.rings.map(o=>o.map(l=>[l[0],l[1],i])),r=e.clone();return r.rings=n,r.hasZ=!0,r}get volumes(){return this._volumes}};u([d()],b.prototype,"_volumes",void 0),u([d({constructOnly:!0})],b.prototype,"view",void 0),b=u([S("esri.views.3d.FocusAreasView")],b);const yt=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:V,build:he},Symbol.toStringTag,{value:"Module"})),Et=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:k,build:de},Symbol.toStringTag,{value:"Module"}));export{b as FocusAreasView};
