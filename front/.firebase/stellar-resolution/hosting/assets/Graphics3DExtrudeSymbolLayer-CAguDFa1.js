import{ak as Bt,P as Tt,az as O,aM as L,aK as tt,aL as et,iV as Ut,iY as Ot,aJ as Ct,aA as V,aV as Vt,aB as Gt,aW as Nt,aX as G,mf as jt,mg as kt,s as Ft,bb as Ht,mh as Wt,mi as qt,mj as lt,ks as X,mk as ut,ml as ht,iW as Jt,b9 as K,mm as Zt,cL as Xt,aO as Kt,au as I,jw as Yt,bh as Q,bm as Qt,kJ as te,j$ as ee,mn as se,mo as ne,aG as pt,kX as ae,mp as ie,mq as oe,mr as re,ms as ce,mt as le,J as ue,mu as he,at as N,hx as W,eR as dt,dS as Et,dT as st,mv as pe,mw as de,mx as me,my as ge,jW as ye,mz as fe,eh as be,ed as mt}from"./index-BCRx-hwS.js";import{t as _e,e as gt}from"./SnappingCandidate-DGkpYqI6.js";import{a as xe}from"./renderingInfoUtils-BAhgEqIm.js";import{c as Se,a as It,p as At}from"./triangulationUtils-Di5oVG4z.js";function Fe(s,t,e){const a=(t.length>0?t[0]:s.length/3)-1,n=Se(s,a,e);if(n!==Ut.Z){s=s.slice();for(let i=0;i<s.length;i+=3)s[i+n]=s[i+2]}return Ot(s,t,3)}function He(s){const t=[[O.POSITION,new L(s.attributeData.position,s.indices,3,!0)]],e=Ct(s.indices.length);return s.attributeData.colorFeature!=null?t.push([O.COLORFEATUREATTRIBUTE,new L([s.attributeData.colorFeature],e,1,!0)]):s.attributeData.color&&t.push([O.COLOR,new L(s.attributeData.color,e,4,!0)]),s.attributeData.uvMapSpace&&t.push([O.UVMAPSPACE,new L(s.attributeData.uvMapSpace,s.indices,4,!0)]),s.attributeData.boundingRect&&t.push([O.BOUNDINGRECT,new L(s.attributeData.boundingRect,s.indices,9,!0)]),new tt(s.material,t,s.mapPositions,et.Mesh,s.attributeData.objectAndLayerIdColor)}function We(s,t=null){const e=[[O.POSITION,new L(s.attributeData.position,s.indices,3,!0)],[O.UV0,new L(s.attributeData.uv0,s.indices,2,!0)]];return new tt(s.material,e,s.mapPositions,et.Mesh,t)}function we(s){switch(s.type){case"extent":if(s instanceof Bt)return Tt.fromExtent(s);break;case"polygon":return s}return null}let qe=class{constructor(t,e,a){this.renderData=t,this.layerViewUid=e,this.graphicUid=a,this.outGeometries=new Array}};function Pe(s,t,e,a){const n=It(s.rings,!!s.hasZ&&a.mode!=="on-the-ground",At.CCW_IS_HOLE,s.spatialReference),i=V(n.position.length),o=Vt(n.position,s.spatialReference,0,i,0,n.position,0,n.position.length/3,t,e,a),l=o!=null;return new Ee(n.position,i,vt(n.polygons,n.position,i),Mt(n.outlines,n.position,i),l,o)}function Ze(s,t){const e=It(s.rings,!1,At.CCW_IS_HOLE),a=Gt(e.position,s.spatialReference,0,e.position,t,0);for(let n=2;n<e.position.length;n+=3)e.position[n]=Nt;return{position:e.position,polygons:vt(e.polygons,e.position),outlines:Mt(e.outlines,e.position),projectionSuccess:a}}function Mt(s,t,e=null){return s.filter(({count:a})=>a>1).map(({index:a,count:n})=>{const i=3*a,o=3*n;return e!=null?new Rt(a,n,G(t,i,o),G(e,i,o)):new nt(a,n,G(t,i,o))})}function vt(s,t,e=null){const a=new Array;for(const{index:n,count:i,holeIndices:o,pathLengths:l}of s){if(i<=1)continue;const c=3*n,g=3*i,y=o.map(m=>m-n),d=e!=null?new Oe(n,i,G(t,3*n,3*i),G(e,c,g),y,l):new Ce(n,i,G(t,3*n,3*i),y,l);a.push(d)}return a}class nt{constructor(t,e,a){this.index=t,this.count=e,this.position=a}}class Rt extends nt{constructor(t,e,a,n){super(t,e,a),this.mapPositions=n}}class Oe extends Rt{constructor(t,e,a,n,i,o){super(t,e,a,n),this.holeIndices=i,this.pathLengths=o}}class Ce extends nt{constructor(t,e,a,n,i){super(t,e,a),this.holeIndices=n,this.pathLengths=i}}class Ee{constructor(t,e,a,n,i,o){this.position=t,this.mapPositions=e,this.polygons=a,this.outlines=n,this.projectionSuccess=i,this.sampledElevation=o}}const Ie=["polygon","extent"];class Xe extends jt{constructor(t,e,a,n){super(t,e,a,n,$e(e)),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const m=kt(this._getSymbolSize());if(m)throw new Ft("graphics3dextrudesymbollayer:invalid-size",m)}const t=this.symbolLayer,e=t==null?void 0:t.material,a=e==null?void 0:e.color,n=this._getCombinedOpacityAndColor(a),i=Ht(n),o=n[3],l=this.needsDrivenTransparentPass,c=e==null?void 0:e.emissive,g={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:o,drivenOpacity:l,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:(c==null?void 0:c.strength)??0,emissiveSource:qt.Color,offsetTransparentBackfaces:!0,normalType:Wt.Compressed},y=new lt(g,this._context);y.setParameters({cullFace:y.transparent?X.None:X.Back});const d=new lt({...g,cullFace:X.Back},this._context);this._materials[R.Main]=y,this._materials[R.Bottom]=d}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,Ie,this.symbolLayer.type))return null;const a=this._getVertexOpacityAndColor(t.renderingInfo,this._getFallbackOpacityAndColor(),255),n=this.setGraphicElevationContext(e);return this._createAs3DShape(e,t.renderingInfo,a,n,e.uid)}layerOpacityChanged(t,e){var o,l,c,g;const a=(l=(o=this.symbolLayer)==null?void 0:o.material)==null?void 0:l.color,n=this._getCombinedOpacity(a);(c=this._materials[R.Main])==null||c.setParameters({opacity:n}),(g=this._materials[R.Bottom])==null||g.setParameters({opacity:n});const i=this._getLayerOpacity();t==null||t.forEach(y=>{var d;return(d=e(y))==null?void 0:d.layerOpacityChanged(i,this._context.isAsync)})}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,ut)}slicePlaneEnabledChanged(t,e){var a,n;return(a=this._materials[R.Main])==null||a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),(n=this._materials[R.Bottom])==null||n.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t==null||t.forEach(i=>{const o=e(i);o!=null&&o.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){var e,a;const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return(e=this._materials[R.Main])==null||e.setParameters(t),(a=this._materials[R.Bottom])==null||a.setParameters(t),!0}_getExtrusionSize(t){let e;return e=t.size&&this._drivenProperties.size?xe(t.size,2)??0:this._getSymbolSize(),e/=this._context.renderCoordsHelper.unitInMeters,e}applyRendererDiff(t,e){return this._drivenPropertiesChanged(e)?ht.RecreateSymbol:ht.RecreateGraphics}async queryForSnapping(t,e,a,n){const i=this._getExtrusionSize(a)*this._context.renderCoordsHelper.unitInMeters/Jt(e),{objectId:o,target:l}=t,c=K(l);switch(c.z=(c.z??0)+i,t.type){case"edge":{const{start:g,end:y}=t,d=K(g),m=K(y);return d.z=(d.z??0)+i,m.z=(m.z??0)+i,[gt(o,c,1/0,d,m)]}case"vertex":return[_e(o,c,1/0),gt(o,l,1/0,l,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,e,a,n,i){const o=we(t.geometry);if(o==null)return null;if(o.rings.length===0||!o.rings.some(A=>A.length>0))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const l=Pe(o,this._context.elevationProvider,this._context.renderCoordsHelper,n);this._logGeometryCreationWarnings(l,o.rings,"rings","ExtrudeSymbol3DLayer");const c=Zt(o);if(c==null)return null;const g=new Array,y=new Array,d=Xt(),m=Q(),E=I(),u=this._context.renderCoordsHelper.viewingMode===Kt.Global;u||this._context.renderCoordsHelper.worldUpAtPosition(null,E),Yt(o.spatialReference,[c.x,c.y,0],m,this._context.renderCoordsHelper.spatialReference);const b=Q();Qt(b,m);const f=ee();te(f,b);const{polygons:x,mapPositions:p,position:_}=l,h=new Map,w=this._materials[R.Main];for(const A of x){const D=A.count;if(this._context.clippingExtent&&(se(A.mapPositions,d),!ne(d,this._context.clippingExtent)))continue;const z=Ot(A.mapPositions,A.holeIndices,3);if(z.length===0)continue;const B=z.length,$=6*D,T=pt($+B),q=pt(B),k=V(3*$),at=V(3*$),it=V(3*$),ot=V($);Ae(_,p,z,A,k,it,at,ot,T,q,this._getExtrusionSize(e),E,u),ae(k,k,b);const rt=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid}),J=new Ue(k,it,ie(at),ot),Z=yt(w,T,T.length-q.length,J,a,rt),Lt=D,Dt=D,zt=2*A.count,ct=new Ve(Lt,Dt,zt,B/3);$t(Z,ct,m),h.set(Z,ct),g.push(Z,yt(this._materials[R.Bottom],q,0,J,a,rt)),y.push(J.heights)}if(g.length===0)return null;const r=new oe({geometries:g,layerViewUid:this._context.layerViewUid,graphicUid:i,isElevationSource:!0});r.transformation=m;const S=re(this.symbolLayer,{opacity:this._getLayerOpacity()}),P=S?new ce(this._materials[R.Main],S,this._context.slicePlaneEnabled):null,M=new le(this,r,null,(A,D,z,B,$)=>Re(A,D,z,B,$,y,h),n,P);return M.alignedSampledElevation=l.sampledElevation,M.needsElevationUpdates=ut(n.mode),M}_getFallbackOpacityAndColor(){var e,a;const t=(a=(e=this.symbolLayer)==null?void 0:e.material)==null?void 0:a.color;return ue.toUnitRGBA(t)??he}}function yt(s,t,e,a,n,i){const o=Ct(t.length),l=[[O.POSITION,new L(a.positions,t,3,!0)],[O.NORMALCOMPRESSED,new L(a.normals,t,2,!0)],[O.COLOR,new L(n,o,4,!0)]];return new tt(s,l,a.elevation,et.Mesh,i,e)}function Ae(s,t,e,a,n,i,o,l,c,g,y,d,m){const E=e.length/3;let u=2*a.count;Me(s,t,a.index,a.count,e,0,E,n,i,o,l,c,g,u,y,d,m);let b=0,f=2*a.count;u=0;const x=a.pathLengths[0];ft(n,i,l,o,b,x,a.count,f,c,u,y),f+=4*x,u+=2*x,b+=x;for(let p=1;p<a.pathLengths.length;++p){const _=a.pathLengths[p];ft(n,i,l,o,b,_,a.count,f,c,u,y),f+=4*_,u+=2*_,b+=_}}function Me(s,t,e,a,n,i,o,l,c,g,y,d,m,E,u,b,f){be(v,b),c??(c=[]),g??(g=[]),y??(y=[]);const x=u>0?1:-1;let p=3*e,_=0,h=3*_,w=a,r=3*w;for(let M=0;M<a;++M){const A=s[p],D=s[p+1],z=s[p+2];f&&(v[0]=A,v[1]=D,v[2]=z,st(v,v)),l[h+0]=A,l[h+1]=D,l[h+2]=z;const B=t[p+0],$=t[p+1],T=t[p+2];c[h+0]=B,c[h+1]=$,c[h+2]=T,g[h+0]=-x*v[0],g[h+1]=-x*v[1],g[h+2]=-x*v[2],y[_]=0,l[r+0]=A+u*v[0],l[r+1]=D+u*v[1],l[r+2]=z+u*v[2],c[r+0]=B,c[r+1]=$,c[r+2]=T,y[w]=u,h+=3,r+=3,p+=3,_+=1,w+=1}p=3*i,h=0,r=3*E;const S=u<0?Pt:wt,P=u<0?wt:Pt;for(let M=0;M<o;++M)m[h]=n[p+S[0]],m[h+1]=n[p+S[1]],m[h+2]=n[p+S[2]],d[r]=n[p+P[0]]+a,d[r+1]=n[p+P[1]]+a,d[r+2]=n[p+P[2]]+a,h+=3,r+=3,p+=3}function F(s,t,e,a,n,i,o){a[i]=a[o],o*=3,s[i*=3]=s[o],s[i+1]=s[o+1],s[i+2]=s[o+2],t[i]=t[o],t[i+1]=t[o+1],t[i+2]=t[o+2],e[i]=n[0],e[i+1]=n[1],e[i+2]=n[2]}const j=I();function ft(s,t,e,a,n,i,o,l,c,g,y){t??(t=[]),e??(e=[]),a??(a=[]);let d=n,m=n+1,E=n+o,u=n+o+1,b=l,f=l+1,x=l+2*i,p=l+2*i+1;y<0&&(d=n+o+1,u=n);let _=3*g;for(let h=0;h<i;++h)h===i-1&&(m=n,y>0?u=n+o:d=n+o),ve(s,d,m,E,j),F(s,t,a,e,j,b,d),F(s,t,a,e,j,f,m),F(s,t,a,e,j,x,E),F(s,t,a,e,j,p,u),c[_]=b,c[_+1]=x,c[_+2]=p,c[_+3]=b,c[_+4]=p,c[_+5]=f,_+=6,d++,m++,E++,u++,b+=2,f+=2,x+=2,p+=2}const Y=I(),bt=I(),_t=I(),xt=I(),St=I();function ve(s,t,e,a,n){t*=3,e*=3,a*=3,N(Y,s[t++],s[t++],s[t++]),N(bt,s[e++],s[e++],s[e++]),N(_t,s[a++],s[a++],s[a++]),mt(xt,bt,Y),mt(St,_t,Y),Et(n,St,xt),st(n,n)}const U=I();function Re(s,t,e,a,n,i,o){const l=s.stageObject,c=l.geometries,g=c.length,y=t.mode!=="absolute-height";let d=0;const m=l.transformation,E=de(Q(),m);for(let u=0;u<g;u+=2){const b=c[u];if(!me(b))continue;const f=b.getMutableAttribute(O.POSITION).data,x=i[u/2],p=new ge(b.mapPositions),_=f.length/3;let h=!1,w=0;{let r=0;for(let S=0;S<_;S++){U[0]=f[r],U[1]=f[r+1],U[2]=f[r+2],a(p,H),y&&(w+=H.sampledElevation),fe.TESTS_DISABLE_OPTIMIZATIONS?(N(C,p.array[p.offset],p.array[p.offset+1],H.z+x[r/3]),e!=null&&n.toRenderCoords(C,e,C),W(C,C,E)):(N(C,f[r],f[r+1],f[r+2]),W(C,C,m),n.setAltitude(C,H.z+x[r/3]),W(C,C,E)),f[r]=C[0],f[r+1]=C[1],f[r+2]=C[2];const P=Le/n.unitInMeters;(Math.abs(U[0]-f[r])>=P||Math.abs(U[1]-f[r+1])>=P||Math.abs(U[2]-f[r+2])>=P)&&(h=!0),p.offset+=3,r+=3}}if(h){const r=o.get(b);r&&$t(b,r,m),l.geometryVertexAttributeUpdated(c[u],O.NORMALCOMPRESSED),b.invalidateBoundingInfo(),l.geometryVertexAttributeUpdated(c[u],O.POSITION),c[u+1].invalidateBoundingInfo(),l.geometryVertexAttributeUpdated(c[u+1],O.POSITION)}d+=w/_}return d/g}function $t(s,t,e){const a=s.getMutableAttribute(O.POSITION),n=s.getMutableAttribute(O.NORMALCOMPRESSED).data,{topVertexStart:i,topVertexCount:o,topFaceStart:l,topFaceCount:c}=t,g=a.data,y=o,d=s.attributes.get(O.POSITION).indices,m=l+c,E=i+o,u=V(3*y);for(let h=0;h<y;++h){const w=3*h;u[w+0]=0,u[w+1]=0,u[w+2]=0}const b=De,f=ze,x=Be,p=Te,_=v;for(let h=l;h<m;++h){const w=3*h;for(let r=0;r<3;++r){const S=d[w+r];p[r]=S;const P=3*S;N(C,g[P+0],g[P+1],g[P+2]),W(b[r],C,e)}dt(f,b[1],b[0]),dt(x,b[2],b[0]),Et(_,f,x),st(_,_);for(let r=0;r<3;++r){const S=3*(p[r]-i);u[S+0]+=_[0],u[S+1]+=_[1],u[S+2]+=_[2]}}for(let h=i;h<E;++h){const w=3*(h-i),r=u[w+0],S=u[w+1],P=u[w+2],M=Math.sqrt(r*r+S*S+P*P);pe(n,h,r/M,S/M,P/M)}}function $e(s){var t,e;return(((e=(t=s.material)==null?void 0:t.color)==null?void 0:e.a)??1)===1}const C=I(),v=I(),H=new ye,wt=[0,2,1],Pt=[0,1,2],Le=.01,De=[I(),I(),I()],ze=I(),Be=I(),Te=[0,0,0];var R;(function(s){s[s.Main=0]="Main",s[s.Bottom=1]="Bottom"})(R||(R={}));class Ue{constructor(t,e,a,n){this.positions=t,this.elevation=e,this.normals=a,this.heights=n}}class Ve{constructor(t,e,a,n){this.topVertexStart=t,this.topVertexCount=e,this.topFaceStart=a,this.topFaceCount=n}}export{We as a,we as b,Ze as c,qe as g,Fe as l,He as m,Ae as n,Pe as p,Xe as s};
