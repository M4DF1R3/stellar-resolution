import{ep as _,dl as b,r,b as m,m as o,s as E,b2 as H,a2 as V,al as w,F as $,Z as c,a3 as I,a as S,b8 as O}from"./index-BCRx-hwS.js";import{C as F,h as z}from"./DynamicLayerView3D-agzPLFGE.js";import{b as C}from"./FlowSubView3D-DsH4XMkT.js";import{w as P}from"./ImageHighlightHelper3D-DDNiZ8Dc.js";import{i as T}from"./timeSupport-CZ-Zr9q3.js";import{O as L,v as N}from"./rasterProjectionHelper-DhhcDsIC.js";import{p as A}from"./popupUtils-CwFAf9xs.js";import"./SubView3D-DDpKXTIC.js";import"./ImageMaterial.glsl-CNRGOIKG.js";import"./DefaultLayouts-DZ3QL_Cj.js";import"./TriangleMaterial-Bf5qGOHH.js";import"./LayerView3D-DHUO1o9J.js";import"./LayerView-B-ORu7tc.js";import"./RefreshableLayerView-Cj-6vaWQ.js";import"./dataUtils-Nj-Pa24a.js";import"./line-CjGKkHIf.js";let u=class extends F{constructor(t){super(t),this.redrawDebounced=_(async e=>{this.redraw((i,a)=>this._redrawImage(i,a),e)},2e3)}initialize(){this.addHandles([b(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this.updatingHandles.addPromise(this.redrawDebounced()))])}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}async processResult(t,e,i){e.imageOrCanvasElement?t.image=e.imageOrCanvasElement:(t.image=document.createElement("canvas"),t.pixelData=e.pixelData,await this._redrawImage(t,i))}async _redrawImage(t,e){if(!(t.image instanceof HTMLCanvasElement)||t.pixelData==null)throw new Error;const i=t.image,a=i.getContext("2d"),s=await this.layer.applyRenderer(t.pixelData,{signal:e}),n=this.layer.applyFilter(s).pixelBlock;if(n==null)throw new Error;i.width=n.width,i.height=n.height;const l=a.createImageData(n.width,n.height);l.data.set(n.getAsRGBA()),a.putImageData(l,0,0)}};u=r([m("esri.views.3d.layers.ImagerySubView3D")],u);const M=t=>{let e=class extends t{constructor(){super(...arguments),this.view=null}get timeExtent(){var i;return T(this.layer,(i=this.view)==null?void 0:i.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(i,a){const{layer:s}=this;if(!i)throw new E("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:n}=s,l=A(s,a);if(!n||l==null)return[];const y=await l.getRequiredFields();H(a);const h=new V;h.timeExtent=this.timeExtent,h.geometry=i,h.outFields=y,h.outSpatialReference=i.spatialReference;const{resolution:d,spatialReference:g}=this.view,f=this.view.type==="2d"?new w(d,d,g):new w(.5*d,.5*d,g),{returnTopmostRaster:x,showNoDataRecords:v}=l.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},R={returnDomainValues:!0,returnTopmostRaster:x,pixelSize:f,showNoDataRecords:v,signal:a==null?void 0:a.signal};return s.queryVisibleRasters(h,R).then(D=>D)}async getSourceScale(){return await N(),await this.layer.load(),L(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){var i;return!!super.canResume()&&!((i=this.timeExtent)!=null&&i.isEmpty)}};return r([o()],e.prototype,"layer",void 0),r([o()],e.prototype,"suspended",void 0),r([o({readOnly:!0})],e.prototype,"timeExtent",null),r([o()],e.prototype,"view",void 0),e=r([m("esri.views.layers.ImageryLayerView")],e),e};let p=class extends M(z){constructor(){super(...arguments),this.type="imagery-3d"}get highlightOptions(){return null}get pixelData(){return null}initialize(){const t=()=>this._updatingHandles.addPromise(this.refreshDebounced());this._updatingHandles.add(()=>{var e,i;return(i=(e=this.layer)==null?void 0:e.exportImageServiceParameters)==null?void 0:i.version},t),this._updatingHandles.add(()=>{var e;return(e=this.layer)==null?void 0:e.renderer},t),this._updatingHandles.add(()=>this.timeExtent,t),this._highlightHelper=new P({view:this.view,layer:this.layer,updatingHandles:this._updatingHandles}),this.addHandles([$(this._highlightHelper),c(()=>this.suspended,e=>this._highlightHelper.suspended=e,I)])}_initSubView(){this.addHandles([c(()=>this.layer.renderer,t=>this._recreateSubView(t),S)])}_recreateSubView(t){var s;const e=(t==null?void 0:t.type)==="flow",i=((s=this.subView)==null?void 0:s.type)==="flow",a=this.subView;a&&e===i||(this.subView=e&&O("enable-feature:3d-flow")?new C({layerView:this}):new u({layerView:this}),a==null||a.destroy())}getFetchOptions(){return{timeExtent:this.timeExtent}}highlight(t,e){return this._highlightHelper.highlight(t,e)}isUpdating(){return super.isUpdating()||this._highlightHelper.updating}};r([o()],p.prototype,"highlightOptions",null),r([o()],p.prototype,"pixelData",null),p=r([m("esri.views.3d.layers.ImageryLayerView3D")],p);const ae=p;export{ae as default};
