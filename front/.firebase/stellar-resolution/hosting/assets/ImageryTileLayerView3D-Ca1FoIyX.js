import{pN as z,pO as V,pP as S,pQ as T,mI as G,pR as E,pS as C,pT as $,pU as p,pV as W,r as d,m as c,b as M,s as j,I as k,cs as Z,Z as J,a as H,b8 as q,pW as Q,pX as X}from"./index-BCRx-hwS.js";import{C as Y,m as v,O as K}from"./rasterProjectionHelper-DhhcDsIC.js";import{b as ee}from"./FlowSubView3D-DsH4XMkT.js";import{l as te}from"./LayerView3D-DHUO1o9J.js";import{p as re}from"./TiledLayerView3D-F5x2XCdV.js";import{r as ie,V as se,a as w,n as ae}from"./datasetUtils-C--lKL1u.js";import{i as ne}from"./timeSupport-CZ-Zr9q3.js";import{p as le}from"./popupUtils-CwFAf9xs.js";import{u as oe}from"./LayerView-B-ORu7tc.js";import{i as ue}from"./RefreshableLayerView-Cj-6vaWQ.js";import"./dataUtils-Nj-Pa24a.js";import"./SubView3D-DDpKXTIC.js";import"./line-CjGKkHIf.js";function he(r,e,t="nearest",i=!1){const s=!(i&&e.pixelType==="u8"),n=s?S.FLOAT:S.UNSIGNED_BYTE,h=e.pixels==null||e.pixels.length===0?null:s?e.getAsRGBAFloat():e.getAsRGBA(),m=r.capabilities.textureFloatLinear,a=new z;return a.width=e.width,a.height=e.height,a.internalFormat=s?V.RGBA32F:$.RGBA,a.samplingMode=!m||t!=="bilinear"&&t!=="cubic"?T.NEAREST:T.LINEAR,a.dataType=n,a.wrapMode=G.CLAMP_TO_EDGE,new E(r,a,h)}function me(r,e){const{spacing:t,offsets:i,coefficients:s,size:[n,h]}=e,m=t[0]>1,a=new z;a.width=m?4*n:n,a.height=h,a.internalFormat=V.RGBA32F,a.dataType=S.FLOAT,a.samplingMode=T.NEAREST,a.wrapMode=G.CLAMP_TO_EDGE;const o=new Float32Array(m?n*h*16:2*i.length);if(m&&s!=null)for(let u=0,l=0;u<s.length;u++)o[l++]=s[u],u%3==2&&(o[l++]=1);else for(let u=0;u<h;u++)for(let l=0;l<n;l++){const _=4*(u*n+l),b=2*(l*h+u);o[_]=i[b],o[_+1]=i[b+1],o[_+3]=i[b]===-1?0:1}return new E(r,a,o)}function F(r,e){const t=new z;return t.internalFormat=$.RGBA,t.width=e.length/4,t.height=1,t.samplingMode=T.NEAREST,t.wrapMode=G.CLAMP_TO_EDGE,new E(r,t,e)}function de(r,e,t,i=1,s=!0){return{u_flipY:s,u_applyTransform:!!r,u_opacity:i,u_transformSpacing:r?r.spacing:C,u_transformGridSize:r?r.size:C,u_targetImageSize:e,u_srcImageSize:t}}function ce(r,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:r?r.length/4-1:0}}function pe(r){return{u_bandCount:r.bandCount,u_minOutput:r.minOutput,u_maxOutput:r.maxOutput,u_minCutOff:r.minCutOff,u_maxCutOff:r.maxCutOff,u_factor:r.factor,u_useGamma:r.useGamma,u_gamma:r.gamma,u_gammaCorrection:r.gammaCorrection}}function fe(r){return{u_hillshadeType:r.hillshadeType,u_sinZcosAs:r.sinZcosAs,u_sinZsinAs:r.sinZsinAs,u_cosZs:r.cosZs,u_weights:r.weights,u_factor:r.factor,u_minValue:r.minValue,u_maxValue:r.maxValue}}const L={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class ye{constructor(e,t,i=null,s=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=i||t.width,this.height=s||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=p(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...L,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||L}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((t,i)=>{var s;return!!((s=this._bandIds)!=null&&s[i])&&t===this._bandIds[i]})||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(t==="bilinear"?T.LINEAR:T.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=p(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=me(e,this.transformGrid))),!0)}getUniforms(e){const{symbolizerParameters:t,transformGrid:i,width:s,height:n,opacity:h}=this,m=de(i,[s,n],[this.source.width,this.source.height],h),a=ce(t.colormap,t.colormapOffset),o=this.symbolizerParameters.type==="stretch"?pe(this.symbolizerParameters):null,u=this.symbolizerParameters.type==="hillshade"?fe(this.symbolizerParameters):null,l=e.emptyTexture;return new W(m,a,o||u,this._rasterTexture??l,this._transformGridTexture??l,this._colormapTexture??l)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(t=>t!=null?t.descriptor.width*t.descriptor.height*4:0).reduce((t,i)=>t+i,0)}return this._memoryUsed}release(){return this._rasterTexture=p(this._rasterTexture),this._transformGridTexture=p(this._transformGridTexture),this._colormapTexture=p(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i!=null&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=p(this._rasterTexture));const s=t==null&&this.bandIds==null||t!=null&&this.bandIds!=null&&t.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&s)return;this._rasterTexture=p(this._rasterTexture);const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=he(e,i,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some((s,n)=>s!==t[n])?(this._colormapTexture=p(this._colormapTexture),this._colormapTexture=F(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=F(e,i),void(this._colormap=i)):(this._colormapTexture=p(this._colormapTexture),void(this._colormap=null))}}const ge=r=>{let e=class extends r{constructor(){super(...arguments),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){var t;return ne(this.layer,(t=this.view)==null?void 0:t.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){try{return this.layer.loaded?Y(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(t){try{return!this.layer.loaded||!!v(this.layer.serviceRasterInfo,t)}catch{return!1}}async fetchPopupFeaturesAtLocation(t,i){var _,b;const{layer:s}=this;if(!t)throw new j("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:n}=s,h=le(s,i);if(!n||h==null)return[];const m=[],{value:a,magdirValue:o,processedValue:u}=await s.identify(t,{timeExtent:this.timeExtent,signal:i==null?void 0:i.signal});let l="";if(a!=null&&a.length){l=s.type==="imagery-tile"&&s.hasStandardTime()&&a[0]!=null?a.map(R=>s.getStandardTimeValue(R)).join(", "):a.join(", ");const f={ObjectId:0};f[w.servicePixelValue]=s.type==="imagery-tile"&&ie(s.raster)?u==null?void 0:u.join(", "):l,f[w.rawServicePixelValue]=l;const x=((_=s.raster)==null?void 0:_.rasterInfo)??s.serviceRasterInfo,O=x==null?void 0:x.attributeTable;if(O!=null){const{fields:R,features:U}=O,A=R.find(({name:y})=>y.toLowerCase()==="value"),D=f[w.servicePixelValue],I=A?U.find(y=>String(y.attributes[A.name])===D):null;if(I)for(const y in I.attributes)I.attributes.hasOwnProperty(y)&&(f[ae+y]=I.attributes[y])}const P=x==null?void 0:x.dataType;P!=="vector-magdir"&&P!=="vector-uv"||(f[w.magnitude]=o==null?void 0:o[0],f[w.direction]=o==null?void 0:o[1]);const{multidimensionalDefinition:N}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});se(s.rasterFields,f,N);const B=new k({geometry:(b=this.fullExtent)==null?void 0:b.clone(),attributes:f,layer:s,sourceLayer:s});m.push(B)}return m}async getSourceScale(){return await this.layer.load(),K(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return v(this.layer.serviceRasterInfo,this.view.spatialReference)}};return d([c()],e.prototype,"fullExtent",null),d([c()],e.prototype,"layer",void 0),d([c({readOnly:!0})],e.prototype,"timeExtent",null),d([c()],e.prototype,"tileInfo",void 0),d([c({readOnly:!0})],e.prototype,"hasTilingEffects",null),d([c()],e.prototype,"datumTransformation",null),e=d([M("esri.views.layers.ImageryTileLayerView")],e),e};let g=class extends ge(ue(re(te(oe)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0,this._flowSubView=null}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new j("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const r=Z(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:t.tilingSchemeLocked}).then(()=>{const e=this.view.basemapTerrain.tilingScheme,t=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(t.format)&&e.compatibleWith(t),this.tileInfo=this._isAlignedMapTile?t:e.toTileInfo(),this._updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(r),this.addHandles(J(()=>this.layer.renderer,e=>this._setSubView(e),H))}destroy(){var r;this.layer.decreaseRasterJobHandlerUsage(),(r=this._flowSubView)==null||r.destroy()}_setSubView(r){if(this.layer.type==="wcs"||!q("enable-feature:3d-flow"))return;const e=(r==null?void 0:r.type)==="flow",t=this._flowSubView;e&&t!=null||(t==null||t.destroy(),this._flowSubView=e?new ee({layerView:this}):null)}get _blankTile(){const r=document.createElement("canvas"),e=r.getContext("2d"),[t,i]=this.tileInfo.size;return r.width=t,r.height=i,e.clearRect(0,0,t,i),e.getImageData(0,0,t,i)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){var i,s;const r=this.layer.tileInfo,e=(i=this.tileInfo.lodAt(0))==null?void 0:i.scale,t=(s=this.layer.tileInfo.lodAt(r.lods.length-1))==null?void 0:s.scale;return this.levelRangeFromScaleRange(e,t)}_getFullExtent(){var r;return v(this.layer.serviceRasterInfo,((r=this.view.basemapTerrain)==null?void 0:r.spatialReference)??this.view.spatialReference)}async fetchTile(r,e){const t=this.tileInfo,i=this._canSymbolizeInWebGL(),s={tileInfo:t,requestRawData:i,signal:e.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,noClip:!1},{layer:n}=this,[h,m,a]=r,o=await n.fetchTile(h,m,a,s);if(o instanceof HTMLImageElement)return o;let u=o==null?void 0:o.pixelBlock;if(u==null)return this._blankTile;if(!i&&(u=await n.applyRenderer(o),u==null))return this._blankTile;const l=new ye([h,m,a],u,t.size[0],t.size[1]);return i?(l.symbolizerRenderer=n.symbolizer.rendererJSON,l.symbolizerParameters=n.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(h)),l.transformGrid=o.transformGrid,l.bandIds=n.bandIds):(l.isRendereredSource=!0,l.bandIds=null),l.interpolation=n.interpolation,l}_getSymbolizerOptions(r){var t;const e=this.tileInfo.lodAt(r).resolution;return{pixelBlock:null,isGCS:((t=this.view.basemapTerrain)==null?void 0:t.spatialReference)!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(r){this._canSymbolizeInWebGL()&&JSON.stringify(r.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(r.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(r.lij[0])))}createFetchPopupFeaturesQueryGeometry(r,e){return Q(r,e,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){var r;this.suspended||(await((r=this._flowSubView)==null?void 0:r.doRefresh()),this.emit("data-changed"))}isUpdating(){var r;return((r=this._flowSubView)==null?void 0:r.updating)??!1}_canSymbolizeInWebGL(){var n,h;const r=X(),{symbolizer:e}=this.layer,t=(n=e.lookup.colormapLut)==null?void 0:n.indexedColormap,i=!!((h=this.layer.rasterFunction)!=null&&h.hasClipFunction),s=t&&t.length>4*(r.maxTextureSize||4096);return e.canRenderInWebGL&&!s&&!i}get test(){}};d([c({readOnly:!0})],g.prototype,"_blankTile",null),d([c({readOnly:!0})],g.prototype,"imageFormatIsOpaque",null),d([c({readOnly:!0})],g.prototype,"hasMixedImageFormats",null),d([c({readOnly:!0})],g.prototype,"dataLevelRange",null),g=d([M("esri.views.3d.layers.ImageryTileLayerView3D")],g);const Pe=g;export{Pe as default};
