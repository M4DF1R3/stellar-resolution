import{r as o,m,b as d,u as x,s as u,b2 as g,ak as P}from"./index-BCRx-hwS.js";import{h as v}from"./DynamicLayerView3D-agzPLFGE.js";import{a as b}from"./ExportWMSImageParameters-CZyQJ0N5.js";import{i as E}from"./timeSupport-CZ-Zr9q3.js";import"./SubView3D-DDpKXTIC.js";import"./ImageMaterial.glsl-CNRGOIKG.js";import"./DefaultLayouts-DZ3QL_Cj.js";import"./TriangleMaterial-Bf5qGOHH.js";import"./LayerView3D-DHUO1o9J.js";import"./LayerView-B-ORu7tc.js";import"./RefreshableLayerView-Cj-6vaWQ.js";const I=r=>{let e=class extends r{initialize(){this.exportImageParameters=new b({layer:this.layer})}destroy(){this.exportImageParameters=x(this.exportImageParameters)}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}get timeExtent(){var t;return E(this.layer,(t=this.view)==null?void 0:t.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(t,a){const{layer:i}=this;if(!t)throw new u("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const{popupEnabled:n}=i;if(!n)throw new u("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:n});const p=this.createFetchPopupFeaturesQuery(t);if(!p)return[];const{extent:h,width:s,height:l,x:y,y:w}=p;if(!(h&&s&&l))throw new u("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:h,width:s,height:l});const f=await i.fetchFeatureInfo(h,s,l,y,w);return g(a),f}};return o([m()],e.prototype,"exportImageParameters",void 0),o([m({readOnly:!0})],e.prototype,"exportImageVersion",null),o([m()],e.prototype,"layer",void 0),o([m({readOnly:!0})],e.prototype,"timeExtent",null),e=o([d("esri.views.layers.WMSLayerView")],e),e};let c=class extends I(v){constructor(){super(...arguments),this.type="wms-3d"}initialize(){this.layer.serviceSupportsSpatialReference(this.view.spatialReference)||this.addResolvingPromise(Promise.reject(new u("layerview:spatial-reference-incompatible","The spatial references supported by this WMS layer are incompatible with the spatial reference of the view"))),this._updatingHandles.add(()=>{var r;return(r=this.exportImageParameters)==null?void 0:r.version},()=>{this._updatingHandles.addPromise(this.refreshDebounced())})}createFetchPopupFeaturesQuery(r){const{subView:e}=this;if(e.type!=="draped")return null;const t=e.findExtentInfoAt(r),a=t.extent,i=new P(a[0],a[1],a[2],a[3],e.spatialReference),n=t.imageSize,p=n.width,h=n.height,s=i.width/p;return{extent:i,width:p,height:h,x:Math.round((r.x-i.xmin)/s),y:Math.round((i.ymax-r.y)/s)}}getFetchOptions(){return{timeExtent:this.timeExtent}}};c=o([d("esri.views.3d.layers.WMSLayerView3D")],c);const A=c;export{A as default};
