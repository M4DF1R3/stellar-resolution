import{e as At}from"./deduplicate-CPLnnGyZ.js";import{au as x,ae as tt,ky as $t,at as R,eh as ot,ej as Y,ed as at,dS as ft,dT as dt,qD as xt,qE as vt,cY as gt,av as Nt,mv as J,g9 as pt,dn as St,cG as ht,az as D}from"./index-BCRx-hwS.js";import{RegularEdgeInstancesLayout as H,SilhouetteEdgeInstancesLayout as G,EdgeInputBufferLayout as Lt}from"./bufferLayouts-BNERraBN.js";class Et{constructor(){this.position0=x(),this.position1=x(),this.faceNormal0=x(),this.faceNormal1=x(),this.componentIndex=0,this.cosAngle=0}}const k=-1;function Ot(t,n,s){const a=t.vertices.position,i=t.vertices.componentIndex,u=m.position0,g=m.position1,p=m.faceNormal0,I=m.faceNormal1,{edges:r,normals:f}=Mt(t),w=r.length/4,A=n.allocate(w);let b=0;const T=w,v=s==null?void 0:s.allocate(T);let F=0,e=0,o=0;U.length=0;for(let d=0;d<w;++d){const S=4*d;a.getVec(r.data[S],u),a.getVec(r.data[S+1],g);const B=U.pushNew();B.index=4*d,B.length=$t(u,g)}U.sort((d,S)=>S.length-d.length);const l=new Array,c=new Array;U.forAll(({length:d,index:S})=>{const B=r.data[S],It=r.data[S+1],et=r.data[S+2],nt=r.data[S+3],st=nt===k;if(a.getVec(B,u),a.getVec(It,g),st){const $=3*et;R(p,f.data[$],f.data[$+1],f.data[$+2]),ot(I,p),m.componentIndex=i.get(B),m.cosAngle=Y(p,I)}else{let $=3*et;if(R(p,f.data[$],f.data[$+1],f.data[$+2]),$=3*nt,R(I,f.data[$],f.data[$+1],f.data[$+2]),m.componentIndex=i.get(B),m.cosAngle=Y(p,I),Vt(m,Tt))return;m.cosAngle<-.9999&&ot(I,p)}e+=d,o++,st||bt(m,Ft)?(n.write(A,b++,m),l.push(d)):Bt(m,mt)&&(v&&s&&s.write(v,F++,m),c.push(d))});const y=new Float32Array(l.reverse()),N=new Float32Array(c.reverse()),L=v&&s?{instancesData:v.slice(0,F),lodInfo:{lengths:N}}:void 0;return{regular:{instancesData:A.slice(0,b),lodInfo:{lengths:y}},silhouette:L,averageEdgeLength:e/o}}function bt(t,n){return t.cosAngle<n}function Vt(t,n){return t.cosAngle>n}function Bt(t,n){const s=xt(t.cosAngle);return vt(rt,t.position1,t.position0),s*(Y(ft(_t,t.faceNormal0,t.faceNormal1),rt)>0?-1:1)>n}function Mt(t){const n=t.faces.length/3,s=t.faces,a=t.neighbors,i=t.vertices.position;h.length=K.length=0;for(let u=0;u<n;u++){const g=3*u,p=a[g],I=a[g+1],r=a[g+2],f=s[g],w=s[g+1],A=s[g+2];i.getVec(f,V),i.getVec(w,C),i.getVec(A,W),at(C,C,V),at(W,W,V),ft(V,C,W),dt(V,V),K.pushArray(V),(p===k||f<w)&&(h.push(f),h.push(w),h.push(u),h.push(p)),(I===k||w<A)&&(h.push(w),h.push(A),h.push(u),h.push(I)),(r===k||A<f)&&(h.push(A),h.push(f),h.push(u),h.push(r))}return{edges:h,normals:K}}class Pt{constructor(){this.index=0,this.length=0}}const U=new tt({allocator:t=>t||new Pt,deallocator:null}),h=new tt({deallocator:null}),K=new tt({deallocator:null}),m=new Et,_t=x(),rt=x(),V=x(),C=x(),W=x(),mt=gt(4),Tt=Math.cos(mt),Dt=gt(35),Ft=Math.cos(Dt);function it(t,n,s){const a=n/3,i=new Uint32Array(s+1),u=new Uint32Array(s+1),g=(e,o)=>{e<o?i[e+1]++:u[o+1]++};for(let e=0;e<a;e++){const o=t[3*e],l=t[3*e+1],c=t[3*e+2];g(o,l),g(l,c),g(c,o)}let p=0,I=0;for(let e=0;e<s;e++){const o=i[e+1],l=u[e+1];i[e+1]=p,u[e+1]=I,p+=o,I+=l}const r=new Uint32Array(6*a),f=i[s],w=(e,o,l)=>{if(e<o){const c=i[e+1]++;r[2*c]=o,r[2*c+1]=l}else{const c=u[o+1]++;r[2*f+2*c]=e,r[2*f+2*c+1]=l}};for(let e=0;e<a;e++){const o=t[3*e],l=t[3*e+1],c=t[3*e+2];w(o,l,e),w(l,c,e),w(c,o,e)}const A=(e,o)=>{const l=2*e,c=o-e;for(let y=1;y<c;y++){const N=r[l+2*y],L=r[l+2*y+1];let d=y-1;for(;d>=0&&r[l+2*d]>N;d--)r[l+2*d+2]=r[l+2*d],r[l+2*d+3]=r[l+2*d+1];r[l+2*d+2]=N,r[l+2*d+3]=L}};for(let e=0;e<s;e++)A(i[e],i[e+1]),A(f+u[e],f+u[e+1]);const b=new Int32Array(3*a),T=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,v=(e,o)=>{const l=T(e,o);b[3*o+l]=-1},F=(e,o,l,c)=>{const y=T(e,o);b[3*o+y]=c;const N=T(l,c);b[3*c+N]=o};for(let e=0;e<s;e++){let o=i[e];const l=i[e+1];let c=u[e];const y=u[e+1];for(;o<l&&c<y;){const N=r[2*o],L=r[2*f+2*c];N===L?(F(e,r[2*o+1],L,r[2*f+2*c+1]),o++,c++):N<L?(v(e,r[2*o+1]),o++):(v(L,r[2*f+2*c+1]),c++)}for(;o<l;)v(e,r[2*o+1]),o++;for(;c<y;)v(r[2*f+2*c],r[2*f+2*c+1]),c++}return b}const X=.7;let wt=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?Ct:Ut}write(n,s,a){j.seed=this._edgeHashFunction(a);const i=j.getIntRange(0,255),u=j.getIntRange(0,this.settings.variants-1),g=j.getFloat(),p=255*(.5*Wt(-(1-Math.min(g/X,1))+Math.max(0,g-X)/(1-X),1.2)+.5);n.position0.setVec(s,a.position0),n.position1.setVec(s,a.position1),n.componentIndex.set(s,a.componentIndex),n.variantOffset.set(s,i),n.variantStroke.set(s,u),n.variantExtension.set(s,p)}};const E=new Float32Array(6),O=new Uint32Array(E.buffer),_=new Uint32Array(1);function Ut(t){return E[0]=t.position0[0],E[1]=t.position0[1],E[2]=t.position0[2],E[3]=t.position1[0],E[4]=t.position1[1],E[5]=t.position1[2],_[0]=31*(31*(31*(31*(31*(166811+O[0])+O[1])+O[2])+O[3])+O[4])+O[5],_[0]}function Ct(t){const n=E;n[0]=M(t.position0[0]),n[1]=M(t.position0[1]),n[2]=M(t.position0[2]),n[3]=M(t.position1[0]),n[4]=M(t.position1[1]),n[5]=M(t.position1[2]),_[0]=5381;for(let s=0;s<O.length;s++)_[0]=31*_[0]+O[s];return _[0]}const ct=1e4;function M(t){return Math.round(t*ct)/ct}function Wt(t,n){return Math.abs(t)**n*Math.sign(t)}const q=class q{constructor(){this._commonWriter=new wt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return H.createBuffer(n)}write(n,s,a){this._commonWriter.write(n,s,a),Nt(P,a.faceNormal0,a.faceNormal1),dt(P,P);const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;J(i,s,P[0],P[1],P[2],u)}};q.Layout=H,q.glLayout=pt(H,1);let Q=q;const z=class z{constructor(){this._commonWriter=new wt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return G.createBuffer(n)}write(n,s,a){this._commonWriter.write(n,s,a);{const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;J(i,s,a.faceNormal0[0],a.faceNormal0[1],a.faceNormal0[2],u)}{const{typedBuffer:i,typedBufferStride:u}=n.normal2Compressed;J(i,s,a.faceNormal1[0],a.faceNormal1[1],a.faceNormal1[2],u)}}};z.Layout=G,z.glLayout=pt(G,1);let Z=z;const P=x(),j=new St;function jt(t){const n=yt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return lt.updateSettings(t.writerSettings),ut.updateSettings(t.writerSettings),Ot(n,lt,ut)}function yt(t,n,s,a){if(n){const g=it(s,a,t.count);return new kt(s,a,g,t)}const i=At(t.buffer,t.stride/4,{originalIndices:s}),u=it(i.indices,a,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:u,vertices:Lt.createView(i.buffer)}}class kt{constructor(n,s,a,i){this.faces=n,this.facesLength=s,this.neighbors=a,this.vertices=i}}const lt=new Q,ut=new Z,qt=ht().vec3f(D.POSITION0).vec3f(D.POSITION1),zt=ht().vec3f(D.POSITION0).vec3f(D.POSITION1).u16(D.COMPONENTINDEX),Xt=Object.freeze(Object.defineProperty({__proto__:null,extract:jt,extractComponentsEdgeLocationsLayout:zt,extractEdgeInformation:yt,extractEdgeLocationsLayout:qt},Symbol.toStringTag,{value:"Module"}));export{Z as N,qt as d,Xt as e,jt as f,zt as g,Ot as p,yt as u,Q as w};
