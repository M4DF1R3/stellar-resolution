import{cQ as k,c5 as G,b2 as O,cR as $,c8 as B}from"./index-BCRx-hwS.js";async function R(o,n,r,s){var F,I;const l=new Array(n.length),u=new Map,d=new Map,h=k(o.fieldsIndex,r.outFields),j=(s==null?void 0:s.hasRequiredFields)??G;for(let e=0;e<n.length;e++){const t=n[e];if(t.isAggregate){l[e]=t;continue}let a=!1;if(s!=null&&s.getPopupTemplate){const c=((F=t.origin)==null?void 0:F.layer)??t.sourceLayer??t.layer,i=s.getPopupTemplate(c);if(i==null)continue;const f=await M(i);O(s),a=f&&f.arcadeUtils.hasGeometryOperations(i)}if(a||!j(t,h)){const c=t.getObjectId();if(c!=null){u.set(c,{graphic:t,index:e});continue}const i=t.getGlobalId();if(i!=null){d.set(i,{graphic:t,index:e});continue}}l[e]=t}if(!o.queryFeatures||u.size===0&&d.size===0)return l.filter(Boolean);const g=[],m=(e,t)=>{t&&(e.outFields??(e.outFields=[]),e.outFields.includes(t)||e.outFields.push(t))};if(u.size>0){const e=r.clone();m(e,o.objectIdField),"uniqueIdFields"in o&&((I=o.uniqueIdFields)!=null&&I.length)&&(e.outFields??(e.outFields=[]),e.outFields.push(...o.uniqueIdFields)),e.objectIds=Array.from(u.keys()),g.push({type:"object-id",query:e,map:u})}const y="globalIdField"in o?o.globalIdField:null;if(y!=null&&d.size>0){const e=r.clone();m(e,y);const t=Array.from(d.keys());e.where=$(r.where,`${y} IN (${t.map(a=>`'${a}'`).join(",")})`),g.push({type:"global-id",query:e,map:d})}const w=(s==null?void 0:s.updateSourceAttributes)??!1;for(const{type:e,query:t,map:a}of g)try{const c=await o.queryFeatures(t,s);for(const i of c.features){const f=e==="object-id"?i.getObjectId():i.getGlobalId();if(f==null)continue;const q=a.get(f);if(!q)continue;const{graphic:p,index:x}=q;if(w&&i.attributes){p.attributes??(p.attributes={});for(const b of h)b in i.attributes&&(p.attributes[b]=i.attributes[b])}const{geometry:A,origin:z}=p;i.geometry||(i.geometry=A),i.origin=z,l[x]=i}}catch{}return l.filter(Boolean)}async function M(o){var n;if((n=o.expressionInfos)!=null&&n.length||Array.isArray(o.content)&&o.content.some(r=>r.type==="expression"))return B()}export{M as r,R as s};
